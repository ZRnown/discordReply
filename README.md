# Discord 自动回复工具

一个功能强大的Discord自动回复桌面应用程序，支持多账号、多规则配置。

## 功能特性

- ✅ 多账号支持：同时管理多个Discord账号
- ✅ Token验证：添加账号时自动验证Token有效性
- ✅ 多规则引擎：支持关键词匹配自动回复
- ✅ 灵活匹配：支持完全匹配、部分匹配、正则表达式匹配
- ✅ 频道限制：可以指定监听特定频道或全部频道
- ✅ 防封控：随机回复延迟，模拟真人行为
- ✅ 图形界面：美观的PySide6界面，支持Mac和Windows
- ✅ 表格界面：行列式数据展示，信息清晰直观
- ✅ 弹窗管理：直观的弹窗式账号和规则配置
- ✅ 内联操作：表格中的编辑和删除按钮，操作便捷
- ✅ 增强日志：彩色日志系统，实时状态监控
- ✅ 配置管理：导入导出配置文件，数据持久化

## ✅ 功能状态

当前版本支持完整的Discord自动回复功能，包含高级的多账号管理！

### 可用的功能
- ✅ 添加和验证Discord账号
- ✅ 配置自动回复规则
- ✅ 实时监听Discord消息
- ✅ **自动回复原消息（引用回复）**
- ✅ 保存和加载配置
- ✅ 账号和规则管理界面
- ✅ Token有效性验证
- ✅ WebSocket连接支持
- ✅ **多账号独立规则配置**
- ✅ **并行账号启动**
- ✅ **灵活的规则分配**

## 安装依赖

```bash
pip install -r requirements.txt
```

## 📚 使用的Discord库

本项目使用 **discord.py-self** 库，这是一个专门为Discord用户账户自动化设计的库。

### 为什么使用 discord.py-self？

- ✅ **专门为用户账户设计**：支持用户Token而不是机器人Token
- ✅ **完整的用户API支持**：包括会话、关系、设置等用户特定功能
- ✅ **防止检测**：优化设计以避免Discord的自动化检测
- ✅ **兼容上游**：大部分API与官方discord.py兼容

### ⚠️ 重要提醒

**使用discord.py-self进行用户账户自动化可能违反Discord的服务条款。请自行承担风险，仅用于学习和个人使用目的。**

## 📋 Discord Token获取指南

### ⚠️ 重要安全提醒
- **不要分享您的Token** 给任何人
- **定期更新Token** 因为它们会过期
- **谨慎使用** 避免账号被封禁

### 🔑 获取用户Token（推荐）

#### 方法1：浏览器开发者工具（推荐）
1. **打开Discord网页版**: https://discord.com/app
2. **登录您的账号**
3. **按 F12** 打开开发者工具
4. **切换到 Application 标签页**
5. **在左侧选择**: Local Storage → discord.com
6. **找到 token 字段**
7. **复制 value 列的值**（完整的字符串）

#### 方法2：Discord客户端
1. **打开Discord桌面客户端**
2. **按 Ctrl+Shift+I** (Windows) 或 **Cmd+Option+I** (Mac)
3. **按照上述步骤操作**

### 📝 Token格式示例
```
正确的用户Token格式：
mfa.XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
或
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

错误的格式：
- 太短（少于20个字符）
- 缺少点号分隔
- 包含特殊字符或空格
```

### 🚨 常见错误及解决

| 错误信息 | 可能原因 | 解决方案 |
|----------|----------|----------|
| `Token不能为空` | 输入为空 | 输入完整的Token |
| `Token长度不正确` | Token太短 | 检查是否完整复制 |
| `Token格式不正确` | 格式错误 | 重新从开发者工具复制 |
| `401 Unauthorized` | Token过期 | 重新获取Token |
| `Improper token` | Token无效 | 检查Token是否正确 |

### 🧪 Token验证
程序会自动验证您输入的Token是否有效。如果验证失败，请：
1. 检查Token是否正确复制
2. 确认Token没有过期
3. 尝试重新登录Discord并获取新Token

### 🆕 新功能详解

### 多账号独立规则配置
- **账号个性化**：每个Discord账号可以配置不同的自动回复规则
- **灵活分配**：同一个规则可以被多个账号使用，也可以只给特定账号使用
- **规则隔离**：未分配给账号的规则不会影响该账号的自动回复行为
- **可视化管理**：直观的规则选择对话框，支持全选/清空操作
- **唯一标识**：每个规则有唯一的ID，确保配置的准确性

### 并行账号启动
- **并发启动**：所有账号同时启动，不再串行等待
- **效率提升**：大幅减少启动时间，特别是多账号情况下
- **独立运行**：每个账号独立运行，互不影响

### 界面优化
- **简化显示**：移除不必要的运行状态列，界面更清爽
- **规则统计**：账号列表显示"已应用规则数/总规则数"
- **直观操作**：一键配置账号规则分配，支持批量选择

### 智能消息回复
- **回复原消息**：使用Discord的原生回复功能，而非普通发送
- **引用显示**：回复消息会显示对原消息的引用
- **上下文清晰**：用户可以清楚看到回复的是哪条消息
- **标准格式**：遵循Discord的回复消息格式规范
- **权限处理**：自动处理权限不足的情况，提供友好提示

## 💡 使用建议
- 定期更换Token以确保安全
- 不要在公共网络上使用
- 监控程序日志了解运行状态
- 合理分配规则给不同账号，避免重复回复
- 网络不稳定时，程序会自动处理连接问题并继续运行
- 如遇到停止超时，不用担心，程序会在后台完成清理

## 🚨 故障排除

### 权限错误 (403 Forbidden)
**错误信息**: `Missing Access` 或 `403 Forbidden (error code: 50001)`

**可能原因**:
- Token没有在此服务器的发送消息权限
- Token在此频道的权限不足
- 服务器设置了特殊权限要求

**解决方案**:
1. 确保Token对应的账号在此服务器有发送消息的权限
2. 检查频道是否有特殊权限设置
3. 尝试更换到有权限的频道
4. 程序会自动跳过无权限的频道，继续监控其他频道

### 停止无效
**现象**: 点击停止后仍显示"运行中"或继续处理消息

**解决方案**:
- 等待几秒钟让停止操作完成
- 如果超时，重新启动程序
- 检查日志中的停止状态信息

### Token验证失败
**错误信息**: `401 Unauthorized` 或 `Improper token has been passed`

**解决方案**:
- 重新从Discord开发者工具获取Token
- 确保完整复制了整个Token字符串
- 检查Token是否过期（定期更换）

### 网络连接问题 (SSL错误)
**错误信息**: `SSL: APPLICATION_DATA_AFTER_CLOSE_NOTIFY` 或 `ClientConnectionError`

**可能原因**:
- 网络连接不稳定
- Discord服务器连接问题
- SSL协议握手失败
- 防火墙或代理干扰

**解决方案**:
- 检查网络连接稳定性
- 等待几分钟后重试
- 如果频繁出现，尝试更换网络环境
- 程序会自动继续运行，不受影响

### 消息发送失败
**错误信息**: 各种HTTP错误

**解决方案**:
- 检查网络连接
- 确认Token有效性
- 查看具体的错误码和信息
- 程序会自动记录详细错误信息

### 停止超时
**现象**: 点击停止后显示"停止超时"

**解决方案**:
- 这是正常现象，程序会在后台完成清理
- 如果持续出现，重新启动程序即可
- 不会影响下次启动

## 📋 技术说明

### 规则标识系统
- **规则ID格式**：`rule_{timestamp}_{index}`
- **唯一性保证**：每个规则都有全局唯一的标识符
- **配置稳定性**：ID确保规则配置的准确映射
- **自动生成**：添加规则时自动生成，无需手动指定

## 使用方法

### 1. 获取Discord Token

1. 打开Discord网页版或客户端
2. 按 `F12` 打开开发者工具
3. 切换到 `Application` → `Local Storage` → `https://discord.com`
4. 找到 `token` 字段，复制其值

⚠️ **重要提醒**：
- 妥善保管你的Token，不要泄露给他人
- 违反Discord服务条款可能导致账号被封禁
- 请合理使用，避免刷屏或骚扰行为

### 2. 运行程序

```bash
python src/main.py
```

### 3. 配置账号

1. 在"账号管理"标签页点击"添加账号"
2. 在弹出的对话框中输入Discord Token
3. 点击"验证Token"按钮，系统会自动验证Token的有效性
4. 验证成功后会显示用户名信息，验证失败会提示错误
5. 勾选"启用账号"并点击确定保存
6. 在表格中查看所有账号信息，包含：
   - Discord用户名（自动从Token获取）
   - Token状态（有效/无效）
   - 运行状态（运行中/未运行）
7. 表格操作：
   - 点击"编辑"按钮修改账号信息
   - 点击"验证"按钮重新验证Token
   - 点击"删除"按钮移除账号
   - 点击"重新验证所有"批量验证所有账号

### 4. 配置规则

1. 在"规则管理"标签页点击"添加规则"
2. 在弹出的对话框中设置：
   - 关键词（用逗号分隔多个关键词）
   - 回复内容
   - 匹配类型（部分匹配/精确匹配/正则表达式）
   - 频道ID（可选，留空则监听所有频道）
   - 回复延迟范围
3. 勾选"启用规则"并点击确定
4. 在表格中查看所有规则信息，可以：
   - 点击"编辑"按钮修改规则设置
   - 点击"删除"按钮移除规则
   - 右键规则行显示快捷菜单
4. 选择匹配类型：
   - `partial`: 部分匹配（推荐）
   - `exact`: 精确匹配
   - `regex`: 正则表达式匹配
5. 设置目标频道ID（可选，为空则监听所有频道）
6. 设置回复延迟范围（防封控）

### 5. 启动机器人

1. 点击底部的"启动"按钮
2. 在"状态监控"标签页查看运行状态
3. 如需停止，点击"停止"按钮
4. 查看"运行日志"了解详细的运行状态和验证结果

## 匹配类型说明

### 部分匹配 (partial)
消息内容包含关键词即触发回复。
```
关键词: "你好", "hello"
消息: "你好啊，今天天气怎么样？" → 触发回复
```

### 精确匹配 (exact)
消息内容完全等于关键词才触发回复。
```
关键词: "你好"
消息: "你好" → 触发回复
消息: "你好啊" → 不触发
```

### 正则表达式匹配 (regex)
使用正则表达式进行匹配。
```
关键词: "价格.*多少"
消息: "这个东西价格多少啊？" → 触发回复
消息: "多少钱" → 不触发
```

## 频道ID获取方法

1. 在Discord中右键点击频道
2. 选择"复制ID"（需要开启开发者模式）
3. 或在频道URL中找到ID数字

## Token验证机制

程序会在以下情况下自动验证Discord Token：

1. **添加账号时**：输入Token后点击"验证Token"按钮
2. **编辑账号时**：修改Token后系统会重新验证
3. **批量验证**：点击"重新验证所有"按钮验证所有账号
4. **单个验证**：点击表格中的"验证"按钮重新验证特定账号

### 验证状态说明

- **✅ 有效**：Token可以正常登录，显示Discord用户名
- **❌ 无效**：Token错误或已过期，无法使用
- **未验证**：尚未进行验证

⚠️ **重要提示**：
- 只有Token验证通过的账号才能正常使用自动回复功能
- 建议定期重新验证账号，特别是长时间未使用的账号
- 如果Token过期，请重新获取新的Token

## 配置导入导出

- **导出配置**：将当前所有账号和规则保存为JSON文件
- **导入配置**：从JSON文件加载账号和规则配置

## 日志系统

程序提供详细的彩色日志系统，帮助您监控运行状态：

### 日志级别
- **ℹ️ 信息**：一般操作信息（蓝色）
- **✅ 成功**：操作成功完成（绿色）
- **⚠️ 警告**：需要注意的情况（橙色）
- **❌ 错误**：操作失败或错误（红色）

### 日志功能
- **实时更新**：操作时自动添加日志
- **时间戳**：每条日志都包含精确时间
- **自动滚动**：默认自动滚动到最新日志（可关闭）
- **清空日志**：随时清空日志内容
- **等宽字体**：使用Consolas字体便于查看

### 常见日志类型
- Token验证结果
- 账号添加/编辑/删除操作
- 规则添加/编辑/删除操作
- 机器人启动/停止状态
- 自动回复触发记录
- 网络连接状态

## 防封控策略

- 随机回复延迟（默认2-5秒）
- 模拟打字状态
- 避免过于频繁的回复
- 支持规则优先级（按顺序匹配，第一个匹配的规则执行）

## 开发和打包

### 开发环境

```bash
# 安装依赖
pip install -r requirements.txt

# 运行程序
python run.py
```

### 打包为可执行文件

#### 🚀 推荐：使用GitHub Actions自动打包

**最简单的方法**：将代码上传到GitHub，自动生成Windows和macOS可执行文件。

1. **上传代码到GitHub**
   - 创建新的GitHub仓库
   - 上传所有项目文件（包括 `.github/workflows/` 目录）
   - 确保包含 `build.py` 和 `requirements.txt`

2. **自动构建触发**
   - 推送代码到 `main` 分支
   - GitHub Actions会自动开始构建
   - 构建完成后在Actions标签页下载产物

3. **下载构建结果**
   - 进入仓库的 **Actions** 标签页
   - 点击最新的workflow运行
   - 在 **Artifacts** 部分下载 `DiscordAutoReply-Windows`

#### 📦 构建产物说明

| 平台 | 文件名 | 大小 | 说明 |
|------|--------|------|------|
| **Windows** | `DiscordAutoReply.exe` | ~50MB | 单文件可执行程序，双击运行 |
| **macOS** | `DiscordAutoReply.app` | ~80MB | 应用程序包 |

#### 🔧 本地打包（可选）

如果需要手动打包：

```bash
# 安装PyInstaller
pip install pyinstaller

# Windows打包
python build.py --target windows

# macOS打包
python build.py --target mac
```

#### ⚠️ 注意事项

- **GitHub Actions免费额度**：每月有一定的免费分钟数
- **构建时间**：Windows构建大约需要5-10分钟
- **文件大小**：包含所有依赖，文件较大但功能完整
- **病毒扫描**：下载后可能被杀毒软件误报，这是正常现象

## 项目结构

```
DiscordReply/
├── src/
│   ├── __init__.py
│   ├── gui.py           # PySide6图形界面
│   ├── discord_client.py # Discord客户端逻辑
│   └── config_manager.py # 配置管理
├── config/              # 配置文件目录
├── assets/              # 资源文件目录
├── run.py               # 程序启动脚本
├── requirements.txt     # Python依赖
└── README.md           # 说明文档
```

## 注意事项

1. **合规使用**：请遵守Discord的服务条款，避免恶意使用
2. **Token安全**：妥善保管Discord Token，不要在公共场合分享
3. **频率控制**：合理设置回复延迟，避免账号被封禁
4. **测试验证**：在测试频道先验证规则是否正常工作

## 技术栈

- **Python 3.8+**
- **discord.py-self**: Discord API封装
- **PySide6**: 跨平台GUI框架 (Qt for Python)
- **PyInstaller**: 打包工具

## 许可证

本项目仅供学习和个人使用，请勿用于商业用途。
# discordReply
